import React, { useEffect, useState } from 'react'
import { Table, Button, Card, Space, Badge, Select } from 'antd'
import { PlusOutlined } from '@ant-design/icons'
import apiService from '../../services/api'

const VulnerabilityList: React.FC = () => {
  const [vulnerabilities, setVulnerabilities] = useState([])
  const [loading, setLoading] = useState(false)
  const [page, setPage] = useState(1)
  const [total, setTotal] = useState(0)

  useEffect(() => {
    fetchVulnerabilities()
  }, [page])

  const fetchVulnerabilities = async () => {
    setLoading(true)
    try {
      const response = await apiService.getVulnerabilities(page, 20)
      setVulnerabilities(response.data?.items || [])
      setTotal(response.data?.total || 0)
    } catch (error) {
      console.error(error)
    } finally {
      setLoading(false)
    }
  }

  const severityColors: { [key: string]: string } = {
    critical: 'red',
    high: 'orange',
    medium: 'gold',
    low: 'blue',
    info: 'cyan',
  }

  const statusColors: { [key: string]: string } = {
    open: 'red',
    verified: 'orange',
    fixed: 'green',
    false_positive: 'default',
    closed: 'default',
  }

  const columns = [
    { title: 'CVE', dataIndex: 'cve_id', key: 'cve_id', width: 120 },
    { title: '标题', dataIndex: 'title', key: 'title', width: 200 },
    {
      title: '严重程度',
      dataIndex: 'severity',
      key: 'severity',
      render: (severity: string) => (
        <Badge color={severityColors[severity] || 'default'} text={severity} />
      ),
    },
    { title: 'CVSS', dataIndex: 'cvss_score', key: 'cvss_score', width: 80 },
    {
      title: '状态',
      dataIndex: 'status',
      key: 'status',
      render: (status: string) => (
        <Badge color={statusColors[status] || 'default'} text={status} />
      ),
    },
    { title: '发现时间', dataIndex: 'discovered_at', key: 'discovered_at', width: 180 },
    {
      title: '操作',
      key: 'action',
      render: () => <Button type="link">查看详情</Button>,
    },
  ]

  return (
    <div style={{ padding: '24px' }}>
      <Card title="漏洞管理">
        <Space style={{ marginBottom: 16 }}>
          <Select placeholder="严重程度" style={{ width: 120 }} allowClear>
            <Select.Option value="critical">严重</Select.Option>
            <Select.Option value="high">高</Select.Option>
            <Select.Option value="medium">中</Select.Option>
            <Select.Option value="low">低</Select.Option>
          </Select>
          <Select placeholder="状态" style={{ width: 120 }} allowClear>
            <Select.Option value="open">未处理</Select.Option>
            <Select.Option value="verified">已验证</Select.Option>
            <Select.Option value="fixed">已修复</Select.Option>
          </Select>
          <Button type="primary">筛选</Button>
        </Space>

        <Table
          columns={columns}
          dataSource={vulnerabilities}
          loading={loading}
          pagination={{
            current: page,
            total: total,
            pageSize: 20,
            showTotal: (total) => `共 ${total} 条`,
            onChange: (p) => setPage(p),
          }}
          rowKey="id"
        />
      </Card>
    </div>
  )
}

export default VulnerabilityList
